# 工资计算软件开发说明

## 1\. 引言

本文档旨在为即将开发的桌面版工资计算软件提供详细的架构设计、模块划分、设计意图及开发顺序说明。该软件旨在解决客户在工资核算中遇到的导入、计算、历史管理和成本分析等痛点，并力求在不引入复杂数据库安装的情况下，提供一个高效、便捷、准确的解决方案。

-----

## 2\. 客户需求分析回顾

通过对客户需求的深入分析，我们总结出以下核心要求：

  * **部署简便：** 直接安装到电脑上使用，无需额外安装数据库等复杂组件。
  * **工资结构多样：** 需包含基础工资、绩效工资、周六加班补偿、竞业补偿、全勤奖等。
  * **考勤与绩效挂钩：** 考勤异常直接扣除绩效工资的百分比。
  * **数据导入：** 支持钉钉考勤表导入，以及Excel模板导入员工信息、工资基础信息、绩效考核结果、社保参保信息、其他奖惩信息。
  * **历史数据管理：** 软件内保留以前的工资核算信息。
  * **数据修正：** 导入数据后，支持在软件内进行单项修改和保存，无需重新导入。
  * **重复人员提醒：** 导入员工信息时，对重复人员进行提醒并提供更新选项。
  * **工资成本分析：** 能够按部门、职级进行横向分析，并按月份、年份进行纵向分析。

-----

## 3\. 总体架构设计

考虑到客户“不要太麻烦去装数据库”的需求，我们将采用**三层架构**结合**嵌入式数据库SQLite**的方案。这种架构模式能够很好地满足桌面应用的功能需求，同时保持部署的简便性。

```
+-------------------+
|    用户界面层 (UI)    |  <-- 用户交互、数据展现
|   (WPF / WinForms)  |
+---------+---------+
          |
          |
+---------+---------+
|    业务逻辑层 (BLL)   |  <-- 核心业务规则、数据处理、协调各模块
|                     |
+---------+---------+
          |
          |
+---------+---------+
|    数据访问层 (DAL)   |  <-- 与SQLite数据库交互、CRUD操作
|                     |
+---------+---------+
          |
          |
+---------+---------+
|   嵌入式数据库 (SQLite) |  <-- 数据存储（.db文件）
|                     |
+-------------------+
```

**设计意图：**

  * **分层解耦：** 各层职责明确，降低模块间的耦合度，提高代码的可维护性和可扩展性。
  * **SQLite优势：** 作为嵌入式数据库，SQLite将所有数据存储在单个文件中，无需单独的数据库服务器进程，完美契合客户对部署简便性的要求。它支持事务、索引等关系型数据库特性，能够保证数据的一致性和查询效率。
  * **技术选型（推荐C\#）：** 考虑到Windows桌面应用生态和现有资源，C\#语言配合WPF或WinForms作为UI框架将是高效的选择。

-----

## 4\. 核心模块设计与开发顺序

我们将按照以下顺序设计和开发各个模块，以确保核心功能的稳定性和数据流的顺畅。

### 4.1. 数据持久化模块 (Data Persistence Module)

  * **设计意图：** 构建软件的底层数据存储基础，确保所有业务数据的可靠存储和高效访问。这是整个软件的基石。
  * **内容：**
      * **SQLite数据库初始化：** 负责创建和管理SQLite数据库文件，包括数据库连接、关闭、错误处理。
      * **基础表结构定义：** 根据业务需求，设计核心的数据库表结构，包括：
          * `Employees` (员工信息表): `EmployeeID` (主键), `Name`, `Department`, `Position`, `HireDate`, `IDNumber`, `ContactInfo`, `IsActive` 等。
          * `SalaryBase` (工资基础信息表): `SalaryBaseID` (主键), `EmployeeID` (外键), `BaseSalary`, `JobGrade`, `EffectiveDate`, `EndDate` 等。
          * `PerformanceScores` (绩效考核结果表): `PerformanceID` (主键), `EmployeeID` (外键), `Score`, `Period`, `Evaluator`, `EvalDate` 等。
          * `SocialSecurity` (社保参保信息表): `SSID` (主键), `EmployeeID` (外键), `SocialSecurityBase`, `MedicalBase`, `ProvidentFundBase`, `EffectiveDate`, `EndDate` 等。
          * `OtherCompensationsPenalties` (其他奖惩信息表): `OCPID` (主键), `EmployeeID` (外键), `Type` (奖/惩), `Amount`, `Reason`, `Date` 等。
          * `AttendanceRecords` (考勤记录表): `AttendanceID` (主键), `EmployeeID` (外键), `Date`, `PunchInTime`, `PunchOutTime`, `Status` (正常/迟到/早退/缺勤/请假), `AbsentHours` 等。
          * `PayrollResults` (工资核算结果表): `PayrollID` (主键), `EmployeeID` (外键), `PayrollMonth`, `BaseSalaryAmount`, `PerformanceSalaryAmount`, `SaturdayOvertimeComp`, `NonCompeteComp`, `FullAttendanceBonus`, `AttendanceDeduction`, `SocialSecurityDeduction`, `ProvidentFundDeduction`, `OtherCompensationAmount`, `OtherPenaltyAmount`, `GrossSalary`, `NetSalary`, `CalculationDate` 等。
          * `PayrollCostAnalysis` (工资成本分析表): `AnalysisID` (主键), `Department`, `Position`, `Month`, `Year`, `TotalSalaryCost`, `AvgSalary` 等，用于存储预聚合的分析数据。
          * `PayrollRules` (工资规则配置表): `RuleID` (主键), `RuleName`, `RuleExpression`, `Description`, `EffectiveDate` 等，用于存储可配置的计算规则。
      * **数据访问接口 (DAL):** 提供统一的CRUD（创建、读取、更新、删除）接口，供业务逻辑层调用，隔离业务逻辑层与底层数据库操作。

### 4.2. 数据导入模块 (Data Import Module)

  * **设计意图：** 实现从外部文件高效、准确地导入各种原始数据，并进行初步校验。
  * **依赖：** 数据持久化模块（需将导入数据存入数据库）。
  * **内容：**
      * **Excel导入器：**
          * 使用 **NPOI** 等库解析 `.xlsx` 格式的Excel文件。
          * 支持导入员工信息、工资基础信息、绩效考核结果、社保参保信息、其他奖惩信息。
          * **模板约定：** 定义清晰的Excel模板格式，指导用户填写。
          * **数据预校验：** 导入前进行基本的数据类型、非空、格式校验。
      * **钉钉考勤导入器：**
          * 解析钉钉导出的考勤表（通常是Excel或CSV格式）。
          * 将考勤数据映射到内部的考勤记录表结构。
          * **字段映射配置：** 考虑提供用户自定义字段映射的功能，以应对钉钉考勤导出格式变化或用户自定义导出字段的情况。
      * **数据校验与错误处理：**
          * **业务校验：** 对导入数据进行更深层次的业务规则校验（如工资基础金额是否合理、社保基数是否符合规定）。
          * **重复人员检测：** 导入员工信息时，根据工号或身份证号检测重复人员。
          * **用户交互：** 发现重复人员或校验错误时，提供清晰的提示信息，并允许用户选择是跳过、更新，或直接在软件中修改错误项。
          * **错误日志：** 记录导入过程中遇到的所有错误和警告，方便用户追溯。

### 4.3. 员工及基础信息管理模块 (Employee & Basic Info Management Module)

  * **设计意图：** 提供用户界面，允许用户查看、修改和管理员工及其相关的基础信息。
  * **依赖：** 数据持久化模块、数据导入模块（用户可在此模块进行单项修改）。
  * **内容：**
      * **员工信息维护：** 增、删、改、查员工基本信息。
      * **工资基础信息维护：** 维护员工的基础工资、职级等。
      * **绩效考核结果维护：** 录入和修改员工的绩效分数。
      * **社保参保信息维护：** 维护员工的社保、公积金缴纳基数和比例。
      * **其他奖惩信息维护：** 录入和修改员工的奖惩记录。
      * **单项修改功能：** 提供友好的UI界面，允许用户直接在数据网格中编辑导入后的数据，并实时保存到SQLite数据库，无需重新导入。

### 4.4. 工资计算引擎模块 (Payroll Calculation Engine Module)

  * **设计意图：** 实现核心的工资计算逻辑，根据各种输入数据得出最终工资。
  * **依赖：** 数据持久化模块（读取员工、考勤、绩效、社保、奖惩数据，写入工资核算结果）、员工及基础信息管理模块（获取最新配置）。
  * **内容：**
      * **规则配置化：** 设计可配置的工资计算规则，存储在 `PayrollRules` 表中。例如：
          * `绩效工资 = 基础工资 * 绩效评分系数`
          * `考勤异常扣减 = 绩效工资 * 考勤异常扣减百分比`
          * `周六加班补偿 = 基础工资/工作日天数 * 加班天数 * 倍数`
          * `全勤奖 = 固定金额 (满足全勤条件)`
      * **计算流程：**
        1.  根据选定月份，从数据库加载所有相关员工的 **基础工资、绩效考核结果、周六加班补偿、竞业补偿、全勤奖、社保参保信息、其他奖惩信息、考勤记录**。
        2.  根据 **考勤记录** 判断考勤异常（迟到、早退、缺勤、请假等），并根据预设规则（如考勤异常扣绩效百分比）计算扣减金额。
        3.  根据 **绩效考核结果** 和 **绩效工资计算规则** 计算绩效工资。
        4.  计算周六加班补偿、竞业补偿、全勤奖等。
        5.  根据 **社保参保信息** 计算社保及公积金扣除。
        6.  汇总 **其他奖惩信息**。
        7.  计算最终的 **应发工资** 和 **实发工资**。
      * **结果存储：** 将每次核算的工资结果存储到 `PayrollResults` 表中，保留历史核算信息。

### 4.5. 历史工资查询与成本分析模块 (Historical Payroll Query & Cost Analysis Module)

  * **设计意图：** 提供历史工资的查询功能，并实现多维度、灵活的工资成本分析报表，帮助客户进行决策。
  * **依赖：** 数据持久化模块（读取 `PayrollResults` 和 `PayrollCostAnalysis`）。
  * **内容：**
      * **历史工资查询：** 允许用户按员工、月份、年份等条件查询历史工资明细。
      * **工资成本分析：**
          * **横向分析：** 按部门、按职级汇算每个月的工资成本总额和平均值。
          * **纵向分析：** 按月份、年份汇算总工资成本和趋势。
          * **数据聚合：** 利用SQLite的聚合函数（SUM, AVG, COUNT, GROUP BY）进行数据聚合。
          * **报表可视化：**
              * 使用 **LiveCharts** 或 **OxyPlot** 等C\#图表库，将分析结果以柱状图、折线图、饼图等形式直观展示。
              * 提供筛选和钻取功能，例如点击部门可查看该部门下各职级的成本构成。

### 4.6. 用户界面 (UI) 模块

  * **设计意图：** 提供直观、友好的用户界面，承载上述所有功能模块的交互。
  * **依赖：** 所有业务逻辑层模块。
  * **内容：**
      * **主界面：** 提供各功能模块的导航入口。
      * **数据导入界面：** 提供文件选择、导入进度、校验结果显示和错误修改功能。
      * **员工及基础信息管理界面：** 提供数据表格展示、编辑、添加、删除功能，支持重复人员提醒和更新选择。
      * **工资核算界面：** 提供月份选择、核算触发按钮、核算进度显示、结果预览功能。
      * **历史查询界面：** 提供查询条件输入、结果列表展示、导出功能。
      * **成本分析界面：** 提供分析维度选择、图表展示、数据表格详情、导出功能。
      * **配置管理界面：** 用于管理工资计算规则、社保公积金比例等参数。

-----

## 5\. 开发建议与注意事项

  * **逐步迭代：** 建议采用敏捷开发模式，逐步实现核心功能，再进行迭代优化。
  * **异常处理：** 在各个模块中都应考虑完善的异常处理机制，提高软件的健壮性。
  * **用户体验：** 导入过程中的进度条、友好的错误提示、清晰的界面布局对于提升用户体验至关重要。
  * **数据备份：** 尽管SQLite是嵌入式数据库，但仍建议在软件中提供数据备份和恢复功能，以防意外。
  * **性能优化：** 针对大量数据导入和复杂报表查询，注意SQL查询优化和数据加载策略。
  * **可扩展性：** 尽管是桌面应用，但在设计时仍应考虑未来可能的业务规则变更，例如通过配置化规则降低代码修改成本。

-----

希望这份开发说明能够为您提供清晰的指导。如有任何疑问或需要进一步的详细设计，请随时提出。